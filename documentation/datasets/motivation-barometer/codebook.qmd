---
title: Codebook
format:
  html:
    toc: true
    toc-depth: 5
    page-layout: full
    smooth-scroll: true
---

# Core module

```{r echo = FALSE, message=FALSE}
library(tidyverse)
library(readxl)
library(flextable)

# 1. Read full codebook from Excel
cb_raw <- read_excel("codebook.xlsx", sheet = 1)

# 2. Helper: get section-specific header text (first non-NA)
get_header <- function(dat, lang = c("en", "nl"), section_id = NULL) {
  lang <- match.arg(lang)

  d <- dat
  if (!is.null(section_id)) {
    d <- d %>% filter(section == section_id)
  }

  colname <- if (lang == "en") "header_en" else "header_nl"

  hdr <- d %>%
    filter(!is.na(.data[[colname]])) %>%
    pull(.data[[colname]])

  if (length(hdr) == 0) {
    return(NULL)
  } else {
    return(hdr[1])
  }
}

# 3. Create English view of the codebook (all variables)
codebook_en <- cb_raw %>%
  transmute(
    variable,
    section,
    label          = label_en,
    item_short     = item_short_en,
    response_scale = response_scale_en,
    response_min,
    response_max,
    type,
    missing,
    notes          = notes_en
  )

# 4. Create Dutch view of the codebook (all variables)
codebook_nl <- cb_raw %>%
  transmute(
    variable,
    section,
    label          = label_nl,
    item_short     = item_short_nl,
    response_scale = response_scale_nl,
    response_min,
    response_max,
    type,
    missing,
    notes          = notes_nl
  )

# 5. General flextable builder (language + optional header text)
make_ft <- function(dat, lang = c("en", "nl"), header = NULL) {
  lang <- match.arg(lang)

  ft <- dat %>%
    select(
      variable, label, item_short,
      response_scale, response_min, response_max,
      type, missing, notes
    ) %>%
    flextable()

  if (lang == "en") {
    ft <- ft %>%
      set_header_labels(
        variable       = "Variable name",
        label          = "Label",
        item_short     = "Item wording (short)",
        response_scale = "Response scale (text)",
        response_min   = "Min",
        response_max   = "Max",
        type           = "Type",
        missing        = "Missing codes",
        notes          = "Notes"
      )

  } else if (lang == "nl") {
    ft <- ft %>%
      set_header_labels(
        variable       = "Variabelenaam",
        label          = "Label",
        item_short     = "Itemformulering (kort)",
        response_scale = "Antwoordschaal (tekst)",
        response_min   = "Min",
        response_max   = "Max",
        type           = "Type",
        missing        = "Missingscodes",
        notes          = "Notities"
      )
  }

  # Optional top header row if 'header' provided
  if (!is.null(header)) {
    ft <- ft %>%
      add_header_row(
        values = header,
        colwidths = 9
      )
  }

  ft %>%
    autofit() %>%
    align(part = "all", align = "left") %>%
    valign(part = "all", valign = "top") %>%
    fontsize(part = "all", size = 9) %>%
    bold(part = "header") %>%
    theme_booktabs() %>%
    bold(i = 1, part = "header") %>%
    merge_h(i = 1, part = "header")
}

```

## Basic Psychological Needs 

### Autonomy

```{r echo = FALSE, message=FALSE}
current_section <- "autonomy"

codebook_en_section <- codebook_en %>% filter(section == current_section)
codebook_nl_section <- codebook_nl %>% filter(section == current_section)

header_en_section <- get_header(cb_raw, lang = "en", section_id = current_section)
header_nl_section <- get_header(cb_raw, lang = "nl", section_id = current_section)

ft_en_aut <- make_ft(codebook_en_section, lang = "en", header = header_en_section)
ft_nl_aut <- make_ft(codebook_nl_section, lang = "nl", header = header_nl_section)


```

<select id="lang-autonomy"> <option value="en">English</option> <option value="nl">Nederlands</option> </select> <div id="tbl-autonomy-en"> `r ft_en_aut` </div> <div id="tbl-autonomy-nl" style="display:none;"> `r ft_nl_aut` </div> <script> document.addEventListener("DOMContentLoaded", function() { const select = document.getElementById("lang-autonomy"); const enDiv = document.getElementById("tbl-autonomy-en"); const nlDiv = document.getElementById("tbl-autonomy-nl"); if (!select || !enDiv || !nlDiv) return; select.addEventListener("change", function() { if (this.value === "en") { enDiv.style.display = ""; nlDiv.style.display = "none"; } else { enDiv.style.display = "none"; nlDiv.style.display = ""; } }); }); </script>

### risk_perception

```{r echo = FALSE, message=FALSE}
current_section <- "comm_style"

codebook_en_section <- codebook_en %>% filter(section == current_section)
codebook_nl_section <- codebook_nl %>% filter(section == current_section)

header_en_section <- get_header(cb_raw, lang = "en", section_id = current_section)
header_nl_section <- get_header(cb_raw, lang = "nl", section_id = current_section)

ft_en_comm <- make_ft(codebook_en_section, lang = "en", header = header_en_section)
ft_nl_comm <- make_ft(codebook_nl_section, lang = "nl", header = header_nl_section)

```

<select id="lang-comm"> <option value="en">English</option> <option value="nl">Nederlands</option> </select> <div id="tbl-comm-en"> `r ft_en_comm` </div> <div id="tbl-comm-nl" style="display:none;"> `r ft_nl_comm` </div> <script> document.addEventListener("DOMContentLoaded", function() { const select = document.getElementById("lang-comm"); const enDiv = document.getElementById("tbl-comm-en"); const nlDiv = document.getElementById("tbl-comm-nl"); if (!select || !enDiv || !nlDiv) return; select.addEventListener("change", function() { if (this.value === "en") { enDiv.style.display = ""; nlDiv.style.display = "none"; } else { enDiv.style.display = "none"; nlDiv.style.display = ""; } }); }); </script>
